<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Secure. Contain. Protect.</title>
  <script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
  <script>(function(e,t,n){typeof define=="function"&&define.amd?define(["jquery"],function(r){return n(r,e,t),r.mobile}):n(e.jQuery,e,t)})(this,document,function(e,t,n,r){(function(e,t,n,r){function T(e){while(e&&typeof e.originalEvent!="undefined")e=e.originalEvent;return e}function N(t,n){var i=t.type,s,o,a,l,c,h,p,d,v;t=e.Event(t),t.type=n,s=t.originalEvent,o=e.event.props,i.search(/^(mouse|click)/)>-1&&(o=f);if(s)for(p=o.length,l;p;)l=o[--p],t[l]=s[l];i.search(/mouse(down|up)|click/)>-1&&!t.which&&(t.which=1);if(i.search(/^touch/)!==-1){a=T(s),i=a.touches,c=a.changedTouches,h=i&&i.length?i[0]:c&&c.length?c[0]:r;if(h)for(d=0,v=u.length;d<v;d++)l=u[d],t[l]=h[l]}return t}function C(t){var n={},r,s;while(t){r=e.data(t,i);for(s in r)r[s]&&(n[s]=n.hasVirtualBinding=!0);t=t.parentNode}return n}function k(t,n){var r;while(t){r=e.data(t,i);if(r&&(!n||r[n]))return t;t=t.parentNode}return null}function L(){g=!1}function A(){g=!0}function O(){E=0,v.length=0,m=!1,A()}function M(){L()}function _(){D(),c=setTimeout(function(){c=0,O()},e.vmouse.resetTimerDuration)}function D(){c&&(clearTimeout(c),c=0)}function P(t,n,r){var i;if(r&&r[t]||!r&&k(n.target,t))i=N(n,t),e(n.target).trigger(i);return i}function H(t){var n=e.data(t.target,s),r;!m&&(!E||E!==n)&&(r=P("v"+t.type,t),r&&(r.isDefaultPrevented()&&t.preventDefault(),r.isPropagationStopped()&&t.stopPropagation(),r.isImmediatePropagationStopped()&&t.stopImmediatePropagation()))}function B(t){var n=T(t).touches,r,i,o;n&&n.length===1&&(r=t.target,i=C(r),i.hasVirtualBinding&&(E=w++,e.data(r,s,E),D(),M(),d=!1,o=T(t).touches[0],h=o.pageX,p=o.pageY,P("vmouseover",t,i),P("vmousedown",t,i)))}function j(e){if(g)return;d||P("vmousecancel",e,C(e.target)),d=!0,_()}function F(t){if(g)return;var n=T(t).touches[0],r=d,i=e.vmouse.moveDistanceThreshold,s=C(t.target);d=d||Math.abs(n.pageX-h)>i||Math.abs(n.pageY-p)>i,d&&!r&&P("vmousecancel",t,s),P("vmousemove",t,s),_()}function I(e){if(g)return;A();var t=C(e.target),n,r;P("vmouseup",e,t),d||(n=P("vclick",e,t),n&&n.isDefaultPrevented()&&(r=T(e).changedTouches[0],v.push({touchID:E,x:r.clientX,y:r.clientY}),m=!0)),P("vmouseout",e,t),d=!1,_()}function q(t){var n=e.data(t,i),r;if(n)for(r in n)if(n[r])return!0;return!1}function R(){}function U(t){var n=t.substr(1);return{setup:function(){q(this)||e.data(this,i,{});var r=e.data(this,i);r[t]=!0,l[t]=(l[t]||0)+1,l[t]===1&&b.bind(n,H),e(this).bind(n,R),y&&(l.touchstart=(l.touchstart||0)+1,l.touchstart===1&&b.bind("touchstart",B).bind("touchend",I).bind("touchmove",F).bind("scroll",j))},teardown:function(){--l[t],l[t]||b.unbind(n,H),y&&(--l.touchstart,l.touchstart||b.unbind("touchstart",B).unbind("touchmove",F).unbind("touchend",I).unbind("scroll",j));var r=e(this),s=e.data(this,i);s&&(s[t]=!1),r.unbind(n,R),q(this)||r.removeData(i)}}}var i="virtualMouseBindings",s="virtualTouchID",o="vmouseover vmousedown vmousemove vmouseup vclick vmouseout vmousecancel".split(" "),u="clientX clientY pageX pageY screenX screenY".split(" "),a=e.event.mouseHooks?e.event.mouseHooks.props:[],f=e.event.props.concat(a),l={},c=0,h=0,p=0,d=!1,v=[],m=!1,g=!1,y="addEventListener"in n,b=e(n),w=1,E=0,S,x;e.vmouse={moveDistanceThreshold:10,clickDistanceThreshold:10,resetTimerDuration:1500};for(x=0;x<o.length;x++)e.event.special[o[x]]=U(o[x]);y&&n.addEventListener("click",function(t){var n=v.length,r=t.target,i,o,u,a,f,l;if(n){i=t.clientX,o=t.clientY,S=e.vmouse.clickDistanceThreshold,u=r;while(u){for(a=0;a<n;a++){f=v[a],l=0;if(u===r&&Math.abs(f.x-i)<S&&Math.abs(f.y-o)<S||e.data(u,s)===f.touchID){t.preventDefault(),t.stopPropagation();return}}u=u.parentNode}}},!0)})(e,t,n),function(e){e.mobile={}}(e),function(e,t){var r={touch:"ontouchend"in n};e.mobile.support=e.mobile.support||{},e.extend(e.support,r),e.extend(e.mobile.support,r)}(e),function(e,t,r){function l(t,n,i,s){var o=i.type;i.type=n,s?e.event.trigger(i,r,t):e.event.dispatch.call(t,i),i.type=o}var i=e(n),s=e.mobile.support.touch,o="touchmove scroll",u=s?"touchstart":"mousedown",a=s?"touchend":"mouseup",f=s?"touchmove":"mousemove";e.each("touchstart touchmove touchend tap taphold swipe swipeleft swiperight scrollstart scrollstop".split(" "),function(t,n){e.fn[n]=function(e){return e?this.bind(n,e):this.trigger(n)},e.attrFn&&(e.attrFn[n]=!0)}),e.event.special.scrollstart={enabled:!0,setup:function(){function s(e,n){r=n,l(t,r?"scrollstart":"scrollstop",e)}var t=this,n=e(t),r,i;n.bind(o,function(t){if(!e.event.special.scrollstart.enabled)return;r||s(t,!0),clearTimeout(i),i=setTimeout(function(){s(t,!1)},50)})},teardown:function(){e(this).unbind(o)}},e.event.special.tap={tapholdThreshold:750,emitTapOnTaphold:!0,setup:function(){var t=this,n=e(t),r=!1;n.bind("vmousedown",function(s){function a(){clearTimeout(u)}function f(){a(),n.unbind("vclick",c).unbind("vmouseup",a),i.unbind("vmousecancel",f)}function c(e){f(),!r&&o===e.target?l(t,"tap",e):r&&e.preventDefault()}r=!1;if(s.which&&s.which!==1)return!1;var o=s.target,u;n.bind("vmouseup",a).bind("vclick",c),i.bind("vmousecancel",f),u=setTimeout(function(){e.event.special.tap.emitTapOnTaphold||(r=!0),l(t,"taphold",e.Event("taphold",{target:o}))},e.event.special.tap.tapholdThreshold)})},teardown:function(){e(this).unbind("vmousedown").unbind("vclick").unbind("vmouseup"),i.unbind("vmousecancel")}},e.event.special.swipe={scrollSupressionThreshold:30,durationThreshold:1e3,horizontalDistanceThreshold:30,verticalDistanceThreshold:30,getLocation:function(e){var n=t.pageXOffset,r=t.pageYOffset,i=e.clientX,s=e.clientY;if(e.pageY===0&&Math.floor(s)>Math.floor(e.pageY)||e.pageX===0&&Math.floor(i)>Math.floor(e.pageX))i-=n,s-=r;else if(s<e.pageY-r||i<e.pageX-n)i=e.pageX-n,s=e.pageY-r;return{x:i,y:s}},start:function(t){var n=t.originalEvent.touches?t.originalEvent.touches[0]:t,r=e.event.special.swipe.getLocation(n);return{time:(new Date).getTime(),coords:[r.x,r.y],origin:e(t.target)}},stop:function(t){var n=t.originalEvent.touches?t.originalEvent.touches[0]:t,r=e.event.special.swipe.getLocation(n);return{time:(new Date).getTime(),coords:[r.x,r.y]}},handleSwipe:function(t,n,r,i){if(n.time-t.time<e.event.special.swipe.durationThreshold&&Math.abs(t.coords[0]-n.coords[0])>e.event.special.swipe.horizontalDistanceThreshold&&Math.abs(t.coords[1]-n.coords[1])<e.event.special.swipe.verticalDistanceThreshold){var s=t.coords[0]>n.coords[0]?"swipeleft":"swiperight";return l(r,"swipe",e.Event("swipe",{target:i,swipestart:t,swipestop:n}),!0),l(r,s,e.Event(s,{target:i,swipestart:t,swipestop:n}),!0),!0}return!1},eventInProgress:!1,setup:function(){var t,n=this,r=e(n),s={};t=e.data(this,"mobile-events"),t||(t={length:0},e.data(this,"mobile-events",t)),t.length++,t.swipe=s,s.start=function(t){if(e.event.special.swipe.eventInProgress)return;e.event.special.swipe.eventInProgress=!0;var r,o=e.event.special.swipe.start(t),u=t.target,l=!1;s.move=function(t){if(!o||t.isDefaultPrevented())return;r=e.event.special.swipe.stop(t),l||(l=e.event.special.swipe.handleSwipe(o,r,n,u),l&&(e.event.special.swipe.eventInProgress=!1)),Math.abs(o.coords[0]-r.coords[0])>e.event.special.swipe.scrollSupressionThreshold&&t.preventDefault()},s.stop=function(){l=!0,e.event.special.swipe.eventInProgress=!1,i.off(f,s.move),s.move=null},i.on(f,s.move).one(a,s.stop)},r.on(u,s.start)},teardown:function(){var t,n;t=e.data(this,"mobile-events"),t&&(n=t.swipe,delete t.swipe,t.length--,t.length===0&&e.removeData(this,"mobile-events")),n&&(n.start&&e(this).off(u,n.start),n.move&&i.off(f,n.move),n.stop&&i.off(a,n.stop))}},e.each({scrollstop:"scrollstart",taphold:"tap",swipeleft:"swipe.left",swiperight:"swipe.right"},function(t,n){e.event.special[t]={setup:function(){e(this).bind(n,e.noop)},teardown:function(){e(this).unbind(n)}}})}(e,this)});</script>
</head>
<body onunload="">
  <div class="form">
    <div class="wrap">
      <div class="left"><button id="prev">&#9664;</button></div>
      <div class="center"><input type="text" id="box"></input><button id="go">go</button></div>
      <div class="right"><button id="next">&#9654;</button></div>
    </div>
  </div>

  <div id="viewer" style="display: none;"></div>
  <div id="loading" style="display: none"><div class="loader">Loading...</div></div>

  <style>
    body { margin: 0 10px; background-color: gray; color: black; }
    a { color: lightgray; font-weight: bold; }
    .form { position: fixed; top: 0px; right: 0px; left: 0px; z-index: 1000; text-align: center; height: 40px; background-color: gray; -webkit-box-shadow: 0px 1px 5px 0px rgba(0,0,0,0.25); -moz-box-shadow: 0px 1px 5px 0px rgba(0,0,0,0.25); box-shadow: 0px 1px 5px 0px rgba(0,0,0,0.25); }
    .wrap { padding: 5px 5px 0px 5px; }
    .form > .wrap > div { display: inline; }
    #box { height: 18px; font-size: 16px; width: 60px; text-align: center; font-weight: bold; vertical-align: middle; }
    button { height: 28px; min-width: 30px; }
    .left { float:left; }
    .right { float: right; }
    #viewer { padding-top: 45px; font-size: 14px; }
    #loading { padding-top: 100px; font-size: 30px; text-align: center; }
    .collapsible-block { cursor: pointer; }
    .loader:before, .loader:after, .loader { border-radius: 50%; width: 2.5em; height: 2.5em; -webkit-animation-fill-mode: both; animation-fill-mode: both; -webkit-animation: load7 1.8s infinite ease-in-out; animation: load7 1.8s infinite ease-in-out; }
    .loader { font-size: 10px; margin: 80px auto; position: relative; text-indent: -9999em; -webkit-transform: translateZ(0); -ms-transform: translateZ(0); transform: translateZ(0); -webkit-animation-delay: -0.16s; animation-delay: -0.16s; }
    .loader:before { left: -3.5em; -webkit-animation-delay: -0.32s; animation-delay: -0.32s; }
    .loader:after { left: 3.5em; }
    .loader:before, .loader:after { content: ''; position: absolute; top: 0; }
    @-webkit-keyframes load7 { 0%, 80%, 100% { box-shadow: 0 2.5em 0 -1.3em lightgray; } 40% { box-shadow: 0 2.5em 0 0 lightgray; } }
    @keyframes load7 { 0%, 80%, 100% { box-shadow: 0 2.5em 0 -1.3em lightgray; } 40% { box-shadow: 0 2.5em 0 0 lightgray; } }
  </style>

  <script>
    // assign a random scp if you're arriving at the page without a query string, so the previous and next functions work
    var curSkip = Math.floor(Math.random() * (2999 - 100 + 1)) + 100;

    // ajax page load happens here. the url is routed through whateverorigin.org to inject CORS headers into the response, allowing use of another site's data from a cross-origin.
    // A json object is returned, and then animations + data insertion into the DOM occurs.
    function loadPage(skip, url, noPush) {
      $('#viewer').fadeOut("fast", function(){
        $('#loading').fadeIn("fast");
      });
      if( skip ) { // if this page is a specific SCP object's article...
        $.getJSON('http://whateverorigin.org/get?url=' + encodeURIComponent('http://www.scp-wiki.net/scp-' + validateSkip(skip) ) + '&callback=?', function(data) { afterPageLoad(data, 1, noPush); } );
      } else if(!skip && url) { // otherwise, if it's a supplemental page or, really, any other page on the site...
        $.getJSON('http://whateverorigin.org/get?url=' + encodeURIComponent('http://www.scp-wiki.net/' + url) + '&callback=?', function(data) { afterPageLoad(data, 0, noPush); } );
      }
    }

    // Clean up the resulting JSON object, and then insert relevant data into the app's DOM
    function afterPageLoad (data, skipYesNo, noPush) {
      var elements = $(data.contents), // convert the returned JSON object (which contains raw HTML) into a jQuery friendly object
          found = $('#page-content', elements), // get the container with the relevant content, and discard the rest
          curTitle = $('#page-title', elements).html(); // update the current title to the newly loaded page's title
      if(skipYesNo) { // if this page was a specific SCP article...
        curSkip = Number(curTitle.replace(/\D/g,'')); // remove all non-numerals in the current page title (i.e. turn SCP-104 into just 104)
        $('#box').val(validateSkip(curSkip)); // update the text box at the top of the app page with the current number
        if(!noPush) { window.history.pushState({}, '', '?scp='+curSkip); } // update the url in the address bar to match the newly loaded page
      }
      found.children('.heritage-rating-module, div[style="text-align: right;"], .footnoteref, .footnotes-footer').remove(); // remove unwanted page elements
      $('#viewer').html(found); // insert the returned AJAX page data into the current page
      $('#loading').fadeOut("fast", function(){ // fade out the loading div
        $('#viewer').fadeIn("fast"); // fade the element containing the new page data back in
      });
      collapsibleLinks(); // make sure any new collapsible links function as intended
    }

    // verifies that the number being inserted into the scp-wiki.net url is valid in their parlance
    function validateSkip(number) {
      number = Number(number);
      if( number < 100 && number >= 10 ) { number = "0"+number; }
      if( number < 10 && number >= 2 ) { number = "00"+number; }
      if( number == 1 ) { number = "002"; }
      if( number >= 2999 ) { number = "2999"; }
      return number;
    }

    // make sure the collapsible links from scp-wiki still function as intended
    function collapsibleLinks() {
      $('.collapsible-block-folded > a').removeAttr("href").click(function(){
        $(this).parent().css("display", "none");
        $(this).parent().parent().children('.collapsible-block-unfolded').fadeIn("slow");
      });
      $('.collapsible-block-unfolded-link > a').removeAttr("href").click(function(){
        $(this).parent().parent().css("display", "none");
        $(this).parent().parent().parent().children('.collapsible-block-folded').fadeIn("slow");
      });
    }

    // ensure our ajax calls have the appropriate meta headers
    $.ajaxSetup({
        scriptCharset: "utf-8",
        contentType: "application/json; charset=utf-8"
    });

    // take the number from the text box and load the page associated with it. otherwise, display an error.
    $('#go').click(function(){
      var boxSkip = $('#box').val();
      if(boxSkip) { loadPage(boxSkip); } else { $('#viewer').html("You didn't enter a number!").fadeIn("fast"); }
    });

    // take the current SCP number, subtract one, and load the page associated with it
    $('#prev').click(function(){
      loadPage(curSkip - 1);
    });

    // same as above, but for going forward one
    $('#next').click(function(){
      loadPage(curSkip + 1);
    });

    // these two functions handle swiping events, and load the previous or next SCP respectively.
    $('#viewer').on("swiperight", function(){
      $('#prev').click();
    });
    $('#viewer').on("swipeleft", function(){
      $('#next').click();
    });

    // make sure that if you arrive on the page from a link (i.e. mikedettmer.com/scp/?scp=054) that the proper page is loaded
    $(window).load(function(){
      var urlSkip = window.location.search.substring(5);
      if( urlSkip ) { loadPage(urlSkip); } else { loadPage(curSkip); }
    });

    // ensure that a link to any supplemental article or a non-scp page will load as expected via the app's AJAX function.
    $(document).on('click','a', function(e){
      e.preventDefault();
      var url = $(this).attr("href").replace(/^.*\/\/[^\/]+/, '');
      loadPage("",url);
    });

    // make sure back and forward browser buttons work as expected
    $(window).on("popstate", function( e ){
      e.preventDefault();
      var urlSkip = window.location.search.substring(5);
      loadPage(urlSkip, null, "noPush");
    });
  </script>
</body>
</html>
